#!/bin/bash
# Task: Debug on Linux with GUI (Ubuntu)
# Usage: mise run debug:linux:gui
# Opens an interactive bash shell in Ubuntu container with GUI environment configured (gui mode)

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ› Debug environment: Ubuntu (gui)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if Docker is installed
if ! command -v docker > /dev/null 2>&1; then
  echo -e "${RED}âŒ Docker is not installed${NC}"
  echo -e "${YELLOW}   Please install Docker to run Linux debug environment${NC}"
  exit 1
fi

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo -e "${RED}âŒ Docker is not running${NC}"
  echo -e "${YELLOW}   Please start Docker daemon${NC}"
  exit 1
fi

echo -e "${GREEN}âœ… Docker is available${NC}"
echo ""

# Use latest Ubuntu LTS
IMAGE="ubuntu:latest"
CONTAINER_NAME="dotfiles-debug-linux-gui-$$"

# Cleanup function
cleanup() {
  echo ""
  echo -e "${BLUE}â–¶${NC} Cleaning up container..."
  docker rm -f "$CONTAINER_NAME" > /dev/null 2>&1 || true
}

# Trap signals to ensure cleanup
trap cleanup EXIT INT TERM

# Pull Ubuntu image if not available
echo -e "${BLUE}â–¶${NC} Preparing Docker image..."
if ! docker image inspect "$IMAGE" > /dev/null 2>&1; then
  echo "  Pulling $IMAGE..."
  docker pull "$IMAGE"
fi
echo -e "${GREEN}âœ… Docker image ready${NC}"
echo ""

# Get available port for VNC (try to find free port starting from 5901)
VNC_PORT=5901
while lsof -Pi :$VNC_PORT -sTCP:LISTEN -t >/dev/null 2>&1; do
  VNC_PORT=$((VNC_PORT + 1))
done

# Create and start container
echo -e "${BLUE}â–¶${NC} Starting Docker container..."
docker run -d \
  --name "$CONTAINER_NAME" \
  -v "$MISE_CONFIG_ROOT:/dotfiles:ro" \
  -p "$VNC_PORT:5901" \
  -e DISPLAY=:1 \
  "$IMAGE" \
  sleep infinity > /dev/null

echo -e "${GREEN}âœ… Container started${NC}"
echo -e "${BLUE}   VNC port: $VNC_PORT (mapped to container port 5901)${NC}"
echo ""

# Install basic dependencies and VNC server
echo -e "${BLUE}â–¶${NC} Installing dependencies and VNC server..."
docker exec "$CONTAINER_NAME" bash -c "
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -qq
  apt-get install -y -qq bash curl git sudo xfce4 xfce4-goodies tigervnc-standalone-server tigervnc-common dbus-x11 > /dev/null 2>&1
" || {
  echo -e "${RED}âŒ Failed to install dependencies${NC}"
  exit 1
}

echo -e "${GREEN}âœ… Dependencies installed${NC}"
echo ""

# Create a test user with sudo
echo -e "${BLUE}â–¶${NC} Setting up environment..."
docker exec "$CONTAINER_NAME" bash -c "
  useradd -m -s /bin/bash testuser 2>/dev/null || true
  echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers 2>/dev/null || true
  mkdir -p /home/testuser
  chown -R testuser:testuser /home/testuser 2>/dev/null || true
" > /dev/null 2>&1 || true

# Copy dotfiles to test user home
echo -e "${BLUE}â–¶${NC} Setting up dotfiles..."
docker exec "$CONTAINER_NAME" bash -c "
  cp -r /dotfiles /home/testuser/dotfiles-repo 2>/dev/null || true
  chown -R testuser:testuser /home/testuser/dotfiles-repo 2>/dev/null || true
  chmod +x /home/testuser/dotfiles-repo/dotfiles /home/testuser/dotfiles-repo/bin/* 2>/dev/null || true
" > /dev/null 2>&1 || true

# Setup VNC server for testuser
echo -e "${BLUE}â–¶${NC} Configuring VNC server..."
docker exec "$CONTAINER_NAME" bash -c "
  mkdir -p /home/testuser/.vnc
  chown -R testuser:testuser /home/testuser/.vnc
  
  # Set VNC password (default: 'password')
  echo 'password' | su - testuser -c 'vncpasswd -f > /home/testuser/.vnc/passwd' 2>/dev/null || true
  chmod 600 /home/testuser/.vnc/passwd 2>/dev/null || true
  
  # Create VNC startup script
  cat > /home/testuser/.vnc/xstartup << 'EOF'
#!/bin/bash
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
/etc/X11/xinit/xinitrc
[ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
[ -r \$HOME/.Xresources ] && xrdb \$HOME/.Xresources
x-window-manager &
startxfce4 &
EOF
  chmod +x /home/testuser/.vnc/xstartup
  chown -R testuser:testuser /home/testuser/.vnc
" > /dev/null 2>&1 || true

# Start VNC server
echo -e "${BLUE}â–¶${NC} Starting VNC server..."
docker exec -d -u testuser -e HOME=/home/testuser "$CONTAINER_NAME" bash -c "
  export USER=testuser
  export HOME=/home/testuser
  vncserver :1 -geometry 1920x1080 -depth 24 > /dev/null 2>&1 || true
  sleep 2
" || true

echo -e "${GREEN}âœ… Environment ready${NC}"
echo ""

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ› Debug environment ready!${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${YELLOW}ğŸ“º VNC Connection:${NC}"
echo -e "  â€¢ VNC Server: localhost:$VNC_PORT"
echo -e "  â€¢ Password: password (default)"
echo -e "  â€¢ Connect using:"
echo -e "    - macOS: open vnc://localhost:$VNC_PORT"
echo -e "    - Linux: vncviewer localhost:$VNC_PORT"
echo -e "    - Or use any VNC client: localhost:$VNC_PORT"
echo ""
echo -e "${YELLOW}ğŸ’¡ Tips:${NC}"
echo -e "  â€¢ Dotfiles are available at: /home/testuser/dotfiles-repo"
echo -e "  â€¢ Run: cd /home/testuser/dotfiles-repo"
echo -e "  â€¢ Run: ./dotfiles apply:files"
echo -e "  â€¢ Exit bash with 'exit' or Ctrl+D"
echo -e "  â€¢ Container will be cleaned up automatically on exit"
echo ""

# Open interactive bash shell
# When bash exits, cleanup will be triggered by trap
docker exec -it -u testuser -w /home/testuser -e HOME=/home/testuser -e DISPLAY=:1 "$CONTAINER_NAME" bash || true

# Explicit cleanup after bash exits
cleanup


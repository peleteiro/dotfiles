#!/bin/bash

# Source validation utilities
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$DIR/validate-url" 2>/dev/null || true

# Detect Homebrew path (Apple Silicon vs Intel)
if [ -d "/opt/homebrew" ]; then
  BREW_PATH="/opt/homebrew"
elif [ -d "/usr/local/Homebrew" ]; then
  BREW_PATH="/usr/local"
else
  BREW_PATH="/opt/homebrew"  # Default for Apple Silicon
fi

# Install homebrew if not already installed
if ! command -v brew > /dev/null 2>&1; then
  echo "Installing Homebrew..."
  HOMEBREW_URL="https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh"
  if validate_url "$HOMEBREW_URL" "Homebrew installer"; then
    /bin/bash -c "$(curl -fsSL "$HOMEBREW_URL")"
  else
    echo "âŒ Could not download Homebrew installer"
    exit 1
  fi
fi

# Setup Homebrew environment
if [ -f "$BREW_PATH/bin/brew" ]; then
  eval "$($BREW_PATH/bin/brew shellenv)"
elif [ -f "/usr/local/bin/brew" ]; then
  eval "$(/usr/local/bin/brew shellenv)"
else
  # Try to find brew in PATH
  if command -v brew > /dev/null 2>&1; then
    eval "$(brew shellenv)"
  else
    echo "Error: Homebrew not found after installation"
    exit 1
  fi
fi

# Update homebrew
brew install git
brew update
brew upgrade

# install mas
brew install mas

# Install bash first to ensure it's available
echo "ðŸ“¦ Installing bash..."
brew install bash

# install essentials
brew install \
aria2 \
autoconf \
automake \
atuin \
awscli \
bash-completion \
bat \
bottom \
colordiff \
coreutils \
delta \
docker-completion \
docker-compose \
dust \
exiftool \
fzf \
gitui \
hub \
gnu-sed \
gpg \
hashdeep \
hyperfine \
imagemagick \
jpegoptim \
jq \
moreutils \
navi \
neovim \
openssl \
ouch \
pip-completion \
pngcrush \
procs \
ripgrep \
rnr \
sd \
sqlite \
ssh-copy-id \
starship \
tealdeer \
tmux \
tree \
wget \
zlib \
exa \
fd \
zoxide \

# Add Homebrew bash to /etc/shells if not already present
BREW_BASH=$(brew --prefix)/bin/bash
if ! grep -q "$BREW_BASH" /etc/shells; then
  echo "Adding Homebrew bash to /etc/shells..."
  echo "$BREW_BASH" | sudo tee -a /etc/shells
fi
echo "âœ… Homebrew bash installed at $BREW_BASH"
echo "   Current bash: $(which bash) ($(bash --version | head -1))"
echo "   To set as default shell, run: chsh -s $BREW_BASH"

# mise
# Note: mise.run doesn't support HEAD requests, so we skip validation and try directly
if ! command -v mise > /dev/null 2>&1; then
  echo "ðŸ“¥ Installing mise..."
  if curl -fsSL https://mise.run | sh; then
    echo "âœ… mise installed"
  else
    echo "âš ï¸  Could not install mise (may need manual installation)"
  fi
else
  echo "âœ… mise already installed"
fi

# Function to install cask only if not already installed
# Checks both Homebrew cask list and if app exists in /Applications
install_cask_if_missing() {
  local cask_name=$1
  local app_name="${2:-}"  # Optional: app name in /Applications (if different from cask name)
  
  # If app_name not provided, try to infer from cask_name
  if [ -z "$app_name" ]; then
    # Common mappings for cask names to app names
    case "$cask_name" in
      "1password") app_name="1Password.app" ;;
      "1password-cli") app_name="" ;;  # CLI tool, no app
      "antigravity") app_name="Antigravity.app" ;;
      "cursor") app_name="Cursor.app" ;;
      "docker") app_name="Docker.app" ;;
      "droplr") app_name="Droplr.app" ;;
      "firefox") app_name="Firefox.app" ;;
      "google-chrome") app_name="Google Chrome.app" ;;
      "google-drive") app_name="Google Drive.app" ;;
      "hammerspoon") app_name="Hammerspoon.app" ;;
      "iconjar") app_name="IconJar.app" ;;
      "intellij-idea") app_name="IntelliJ IDEA.app" ;;
      "iterm2") app_name="iTerm.app" ;;
      "sublime-merge") app_name="Sublime Merge.app" ;;
      "sublime-text") app_name="Sublime Text.app" ;;
      "tableplus") app_name="TablePlus.app" ;;
      "the-unarchiver") app_name="The Unarchiver.app" ;;
      "transmit") app_name="Transmit.app" ;;
      "visual-studio-code") app_name="Visual Studio Code.app" ;;
      "vlc") app_name="VLC.app" ;;
      *) app_name="" ;;  # Unknown, will only check Homebrew
    esac
  fi
  
  # Check if already installed via Homebrew
  if brew list --cask "$cask_name" > /dev/null 2>&1; then
    echo "âœ… $cask_name already installed (via Homebrew)"
    return 0
  fi
  
  # Check if app exists in /Applications (if app_name provided)
  if [ -n "$app_name" ] && [ -d "/Applications/$app_name" ]; then
    echo "âœ… $cask_name already installed (found in /Applications)"
    return 0
  fi
  
  # Not installed, install it
  echo "ðŸ“¥ Installing $cask_name..."
  brew install --cask "$cask_name"
}

# install "out of appstore" apps
install_cask_if_missing 1password
install_cask_if_missing 1password-cli
install_cask_if_missing antigravity
install_cask_if_missing cursor
install_cask_if_missing docker
install_cask_if_missing droplr
install_cask_if_missing firefox
install_cask_if_missing google-chrome
install_cask_if_missing google-drive
install_cask_if_missing hammerspoon
install_cask_if_missing iconjar
install_cask_if_missing intellij-idea
install_cask_if_missing iterm2
install_cask_if_missing sublime-merge
install_cask_if_missing sublime-text
install_cask_if_missing tableplus
install_cask_if_missing the-unarchiver
install_cask_if_missing transmit
install_cask_if_missing visual-studio-code
install_cask_if_missing vlc

# install appstore apps
echo "ðŸ’¿ Amphetamine" && mas install 937984704
echo "ðŸ’¿ Audio Lock" && mas install 1460671099
echo "ðŸ’¿ Brother P Touch Editor" && mas install 1453365242
echo "ðŸ’¿ Capto" && mas install 1078184147
echo "ðŸ’¿ DaisyDisk" && mas install 411643860
echo "ðŸ’¿ Dato" && mas install 1470584107
echo "ðŸ’¿ HTTPBot" && mas install 1232603544
echo "ðŸ’¿ KeepSolid VPN" && mas install 694633015
echo "ðŸ’¿ Microsoft Remote Desktop" && mas install 1295203466
echo "ðŸ’¿ Monodraw" && mas install 920404675
echo "ðŸ’¿ Pastel" && mas install 413897608
echo "ðŸ’¿ Pixelmator Pro" && mas install 1289583905
echo "ðŸ’¿ Slack" && mas install 803453959
echo "ðŸ’¿ Spark Mail" && mas install 6445813049
echo "ðŸ’¿ TextSniper OCR" && mas install 1528890965
echo "ðŸ’¿ Typeface 3" && mas install 1062679359
echo "ðŸ’¿ Whatsapp Desktop" && mas install 310633997
echo "ðŸ’¿ XCode" && mas install 497799835
echo "ðŸ’¿ xScope 4" && mas install 889428659
echo "ðŸ’¿ Yubico Authenticator" && mas install 1497506650

# Android-SDK (sÃ³ instala se nÃ£o estiver instalado)
ANDROID_SDK_DIR="$HOME/.local/share/android"
if [ ! -d "$ANDROID_SDK_DIR/cmdline-tools" ] || [ ! -f "$ANDROID_SDK_DIR/cmdline-tools/latest/bin/sdkmanager" ]; then
  echo "ðŸ“± Installing Android SDK..."
  
  # Instalar OpenJDK se nÃ£o estiver instalado
  if ! brew list openjdk > /dev/null 2>&1; then
    brew install openjdk
  fi
  
  BREW_PREFIX=$(brew --prefix)
  if [ ! -L "/Library/Java/JavaVirtualMachines/openjdk.jdk" ]; then
    sudo ln -sfn "$BREW_PREFIX/opt/openjdk/libexec/openjdk.jdk" /Library/Java/JavaVirtualMachines/openjdk.jdk
  fi
  
  # Baixar e instalar command line tools
  ANDROID_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-mac-6858069_latest.zip"
  if validate_url "$ANDROID_TOOLS_URL" "Android command line tools"; then
    if safe_download "$ANDROID_TOOLS_URL" /tmp/commandlinetools.zip "Android command line tools"; then
      rm -rf /tmp/commandlinetools-tmp-unzip
      mkdir -p /tmp/commandlinetools-tmp-unzip
      # Use ouch if available (installed earlier), otherwise fallback to unzip
      if command -v ouch > /dev/null 2>&1; then
        ouch decompress /tmp/commandlinetools.zip --dir /tmp/commandlinetools-tmp-unzip
      else
        unzip -n /tmp/commandlinetools.zip -d /tmp/commandlinetools-tmp-unzip
      fi
      mkdir -p "$ANDROID_SDK_DIR"
      cd "$ANDROID_SDK_DIR" && /tmp/commandlinetools-tmp-unzip/cmdline-tools/bin/sdkmanager --install "cmdline-tools;latest" --sdk_root="$ANDROID_SDK_DIR"
      rm -rf /tmp/commandlinetools-tmp-unzip
      rm /tmp/commandlinetools.zip
    else
      echo "âš ï¸  Skipping Android SDK installation due to download failure"
      exit 1
    fi
  else
    echo "âš ï¸  Skipping Android SDK installation due to URL validation failure"
    exit 1
  fi
  
  echo "âœ… Android SDK installed"
else
  echo "âœ… Android SDK already installed"
fi

# PlatformIO (via Homebrew)
if ! command -v platformio > /dev/null 2>&1; then
  echo "ðŸ“¥ Installing PlatformIO via Homebrew..."
  if brew install platformio; then
    echo "âœ… PlatformIO installed"
  else
    echo "âš ï¸  Could not install PlatformIO via Homebrew"
  fi
else
  echo "âœ… PlatformIO already installed"
fi

# Rustup
if ! command -v rustup > /dev/null 2>&1; then
  RUSTUP_URL="https://sh.rustup.rs"
  if validate_url "$RUSTUP_URL" "Rustup installer"; then
    curl --proto '=https' --tlsv1.2 -sSf "$RUSTUP_URL" | sh
  else
    echo "âš ï¸  Could not download Rustup installer"
  fi
fi

# Node.js (required for Gemini CLI)
if ! command -v node > /dev/null 2>&1; then
  echo "Installing Node.js..."
  brew install node
fi

# Gemini CLI
if ! command -v gemini > /dev/null 2>&1; then
  echo "Installing Gemini CLI..."
  npm install -g @google/gemini-cli
  echo "ðŸ’¡ Run 'gemini auth login' to authenticate with Google"
fi

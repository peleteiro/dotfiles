#!/bin/bash
# Script to verify dotfiles integrity

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
ERRORS=0
WARNINGS=0

echo "ğŸ” Checking dotfiles..."
echo ""

# Check if main files exist in repository
check_file() {
  local file="$1"
  local description="$2"
  
  if [ -f "$DIR/home/$file" ]; then
    echo "  âœ… $description: $file"
  else
    echo "  âŒ $description: $file (NOT FOUND)"
    ((ERRORS++))
  fi
}

# Check if files were copied to home
check_installed() {
  local file="$1"
  local description="$2"
  
  if [ -f "$HOME/$file" ]; then
    echo "  âœ… $description installed: $file"
  else
    echo "  âš ï¸  $description not installed: $file"
    ((WARNINGS++))
  fi
}

echo "ğŸ“¦ Checking files in repository:"
check_file ".bash_profile" "Bash profile"
check_file ".bashrc" "Bash rc"
check_file ".bash_functions" "Bash functions"
check_file ".zshrc" "Zsh rc"
check_file ".zprofile" "Zsh profile"
check_file ".zsh_functions" "Zsh functions"
check_file ".shared_shell_config" "Shared configuration"
check_file ".shared_shell_config-macos" "macOS shared configuration"
check_file ".shared_shell_config-linux" "Linux shared configuration"
check_file ".gitconfig" "Git config"
check_file ".tmux.conf" "Tmux config"
check_file ".dircolors" "Dircolors"
echo ""

echo "ğŸ  Checking installed files:"
check_installed ".bash_profile" "Bash profile"
check_installed ".bashrc" "Bash rc"
check_installed ".zshrc" "Zsh rc"
check_installed ".zprofile" "Zsh profile"
check_installed ".shared_shell_config" "Shared configuration"
echo ""

# Check available shells
echo "ğŸš Checking available shells:"
if command -v bash > /dev/null; then
  BASH_VERSION=$(bash --version | head -n1)
  echo "  âœ… Bash: $BASH_VERSION"
else
  echo "  âš ï¸  Bash not found"
  ((WARNINGS++))
fi

if command -v zsh > /dev/null; then
  ZSH_VERSION=$(zsh --version)
  echo "  âœ… Zsh: $ZSH_VERSION"
else
  echo "  âš ï¸  Zsh not found"
  ((WARNINGS++))
fi
echo ""

# Check important dependencies
echo "ğŸ“‹ Checking dependencies:"
check_dep() {
  local cmd="$1"
  local name="$2"
  
  if command -v "$cmd" > /dev/null; then
    echo "  âœ… $name installed"
  else
    echo "  âš ï¸  $name not installed"
    ((WARNINGS++))
  fi
}

check_dep "git" "Git"
check_dep "nvim" "Neovim"
check_dep "tmux" "Tmux"
check_dep "fzf" "fzf"
check_dep "bat" "bat"
check_dep "delta" "delta"
check_dep "rg" "ripgrep"

# Check mise
if [ -f ~/.local/bin/mise ] || command -v mise > /dev/null 2>&1; then
  echo "  âœ… mise installed"
else
  echo "  âš ï¸  mise not installed"
  ((WARNINGS++))
fi

# Check rustup
if [ -f ~/.cargo/env ] || command -v rustup > /dev/null 2>&1; then
  echo "  âœ… Rustup installed"
else
  echo "  âš ï¸  Rustup not installed"
  ((WARNINGS++))
fi

# Check 1Password CLI
if command -v op > /dev/null 2>&1; then
  if op account list &>/dev/null 2>&1; then
    echo "  âœ… 1Password CLI installed and authenticated"
  else
    echo "  âš ï¸  1Password CLI installed but not authenticated (run 'op signin')"
    ((WARNINGS++))
  fi
else
  echo "  âš ï¸  1Password CLI not installed"
  ((WARNINGS++))
fi

# Check GPG
if command -v gpg > /dev/null 2>&1; then
  if gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep -q "^sec"; then
    echo "  âœ… GPG installed with secret keys"
  else
    echo "  âš ï¸  GPG installed but no secret keys found"
    ((WARNINGS++))
  fi
else
  echo "  âš ï¸  GPG not installed"
  ((WARNINGS++))
fi

# Check Docker (if installed)
if command -v docker > /dev/null 2>&1; then
  if docker info &>/dev/null 2>&1; then
    echo "  âœ… Docker installed and running"
  else
    echo "  âš ï¸  Docker installed but not running"
    ((WARNINGS++))
  fi
else
  echo "  â„¹ï¸  Docker not installed (optional)"
fi

# Check Node.js
if command -v node > /dev/null 2>&1; then
  NODE_VERSION=$(node --version)
  echo "  âœ… Node.js installed: $NODE_VERSION"
else
  echo "  âš ï¸  Node.js not installed"
  ((WARNINGS++))
fi

# Check Rust utilities (if rustup is installed)
if command -v rustup > /dev/null 2>&1; then
  echo ""
  echo "ğŸ”§ Checking Rust utilities:"
  for util in dust procs bottom ouch tealdeer hyperfine gitui atuin navi; do
    if command -v "$util" > /dev/null 2>&1; then
      echo "  âœ… $util installed"
    else
      echo "  âš ï¸  $util not installed"
      ((WARNINGS++))
    fi
  done
fi

# Check package manager repositories
echo ""
echo "ğŸ“¦ Checking package manager repositories:"

# Check Homebrew (macOS)
if [[ "$(uname)" == "Darwin" ]]; then
  if command -v brew > /dev/null 2>&1; then
    # Check if Homebrew is working (don't actually update, just check status)
    if brew --version &>/dev/null; then
      # Check if there are outdated packages (without updating)
      BEHIND=$(brew outdated 2>/dev/null | wc -l | tr -d ' ')
      if [ "$BEHIND" -eq 0 ]; then
        echo "  âœ… Homebrew is working and up to date"
      else
        echo "  âš ï¸  Homebrew has $BEHIND outdated packages (run 'brew upgrade')"
        ((WARNINGS++))
      fi
    else
      echo "  âš ï¸  Homebrew not working properly"
      ((WARNINGS++))
    fi
  else
    echo "  âš ï¸  Homebrew not installed"
    ((WARNINGS++))
  fi
fi

# Check apt repositories (Linux)
if [[ "$(uname)" == "Linux" ]]; then
  if command -v apt > /dev/null 2>&1; then
    # Check if apt repositories are configured
    if [ -f /etc/apt/sources.list ] || [ -d /etc/apt/sources.list.d ]; then
      # Check if we can update package lists
      if sudo apt update &>/dev/null; then
        echo "  âœ… APT repositories are configured and accessible"
      else
        echo "  âš ï¸  APT repositories may have issues (run 'sudo apt update' to check)"
        ((WARNINGS++))
      fi
    else
      echo "  âš ï¸  APT repositories not configured"
      ((WARNINGS++))
    fi
  else
    echo "  â„¹ï¸  APT not available (not a Debian/Ubuntu system)"
  fi
fi
echo ""

# Summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
  echo "âœ… All OK! No issues found."
  exit 0
elif [ $ERRORS -eq 0 ]; then
  echo "âš ï¸  Check completed with $WARNINGS warning(s)."
  exit 0
else
  echo "âŒ Check failed with $ERRORS error(s) and $WARNINGS warning(s)."
  exit 1
fi


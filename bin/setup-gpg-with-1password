#!/bin/bash
# Setup/Reimport GPG key from 1Password and configure Git
# Works on both macOS and Linux
# This script can be run manually to fix GPG setup issues

set -e

OP_PGP_KEY_ID="b2lpibkkqfqtp5lvvp25ugx3kq"
FORCE_REIMPORT=false

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --force|-f)
      FORCE_REIMPORT=true
      shift
      ;;
    --help|-h)
      echo "Usage: $0 [--force|-f]"
      echo ""
      echo "Setup or reimport GPG key from 1Password and configure Git."
      echo ""
      echo "Options:"
      echo "  --force, -f    Force reimport even if key already exists"
      echo "  --help, -h     Show this help message"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      echo "Run '$0 --help' for usage information"
      exit 1
      ;;
  esac
done

echo "ðŸ” Setting up GPG key from 1Password..."

# Check if 1Password CLI is installed
if ! command -v op > /dev/null 2>&1; then
  echo "âŒ 1Password CLI (op) not found."
  echo ""
  echo "Please install 1Password CLI:"
  echo "  macOS:   brew install --cask 1password-cli"
  echo "  Linux:   See https://developer.1password.com/docs/cli/get-started"
  exit 1
fi

# Check if user is signed in to 1Password
if ! op account list &>/dev/null 2>&1; then
  echo "âŒ Not signed in to 1Password."
  echo ""
  echo "Please sign in first:"
  echo "  op signin"
  echo ""
  echo "Then run this script again."
  exit 1
fi

# Create .gnupg directory if it doesn't exist
mkdir -p ~/.gnupg
chmod 700 ~/.gnupg

# Get key from 1Password as document
echo "ðŸ“¥ Retrieving PGP key from 1Password..."
KEY_CONTENT=$(op document get "$OP_PGP_KEY_ID" 2>/dev/null) || {
  echo "âŒ Could not retrieve PGP key from 1Password."
  echo ""
  echo "Troubleshooting:"
  echo "  1. Verify you're signed in: op account list"
  echo "  2. Check the item ID is correct: $OP_PGP_KEY_ID"
  echo "  3. Verify the item exists and is accessible: op item get $OP_PGP_KEY_ID"
  echo "  4. Make sure the item is a Document type in 1Password"
  exit 1
}

if [ -z "$KEY_CONTENT" ]; then
  echo "âŒ PGP key content is empty."
  echo ""
  echo "The document in 1Password appears to be empty."
  echo "Please verify the document contains a valid PGP private key."
  exit 1
fi

# Check if key is already imported
HAS_EXISTING_KEY=false
if gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep -q "^sec"; then
  HAS_EXISTING_KEY=true
fi

if [ "$HAS_EXISTING_KEY" = true ] && [ "$FORCE_REIMPORT" = false ]; then
  echo "âœ… GPG key already imported"
  echo ""
  echo "Current keys:"
  gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep "^sec" || true
  echo ""
  echo "To force reimport, run: $0 --force"
  echo ""
  
  # Just configure Git if not already set
  if [ -z "$(git config --global user.signingkey 2>/dev/null)" ]; then
    FINGERPRINT=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep "^sec" | awk '{print $2}' | cut -d'/' -f2 | head -n1)
    if [ -n "$FINGERPRINT" ]; then
      git config --global user.signingkey "$FINGERPRINT" 2>/dev/null || true
      echo "âœ… Git signing key configured: $FINGERPRINT"
    fi
  else
    CURRENT_KEY=$(git config --global user.signingkey 2>/dev/null)
    echo "âœ… Git signing key already configured: $CURRENT_KEY"
  fi
else
  # Import key (or reimport if forced)
  if [ "$FORCE_REIMPORT" = true ] && [ "$HAS_EXISTING_KEY" = true ]; then
    echo "ðŸ”„ Force reimporting GPG key..."
  else
    echo "ðŸ“¥ Importing GPG key..."
  fi
  
  TMP_KEY=$(mktemp)
  echo "$KEY_CONTENT" > "$TMP_KEY"
  
  # Import the key
  if gpg --import "$TMP_KEY" 2>&1; then
    echo "âœ… GPG key imported successfully"
    
    # Get fingerprint and configure Git
    FINGERPRINT=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep "^sec" | awk '{print $2}' | cut -d'/' -f2 | head -n1)
    
    if [ -n "$FINGERPRINT" ]; then
      git config --global user.signingkey "$FINGERPRINT" 2>/dev/null || true
      echo "âœ… Git signing key configured: $FINGERPRINT"
      
      # Enable commit signing by default
      if [ -z "$(git config --global commit.gpgsign 2>/dev/null)" ]; then
        git config --global commit.gpgsign true 2>/dev/null || true
        echo "âœ… Git commit signing enabled"
      fi
    else
      echo "âš ï¸  Could not extract key fingerprint"
      echo "   Check with: gpg --list-secret-keys"
    fi
  else
    echo "âŒ Key import failed"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Verify the key content is valid:"
    echo "     op document get $OP_PGP_KEY_ID | head -20"
    echo "  2. Check for existing keys:"
    echo "     gpg --list-secret-keys"
    echo "  3. Try importing manually:"
    echo "     op document get $OP_PGP_KEY_ID > /tmp/key.asc"
    echo "     gpg --import /tmp/key.asc"
    exit 1
  fi
  
  rm -f "$TMP_KEY"
fi

# Verify GPG agent configuration
if [ -f ~/.gnupg/gpg-agent.conf ]; then
  if grep -q "pinentry-program" ~/.gnupg/gpg-agent.conf; then
    echo "âœ… GPG agent configured for 1Password"
  else
    echo "âš ï¸  GPG agent not configured for 1Password"
    echo "   Run './dotfiles apply:files' to configure it"
  fi
else
  echo "âš ï¸  GPG agent configuration not found"
  echo "   Run './dotfiles apply:files' to set it up"
fi

# Reload GPG agent
gpg-connect-agent reloadagent /bye 2>/dev/null || true

echo ""
echo "âœ… GPG setup complete!"
echo ""
echo "Verify your setup:"
echo "  gpg --list-secret-keys"
echo "  git config --global user.signingkey"
echo "  git config --global commit.gpgsign"


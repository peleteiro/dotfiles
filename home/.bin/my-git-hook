#!/bin/bash
set -euo pipefail

# my-git-hook CLI
# Manage AI-powered git hooks

# Determine hooks directory
HOOKS_DIR="$HOME/.my-git-hooks"

if [ ! -d "$HOOKS_DIR" ]; then
  echo "‚ùå Git hooks directory not found at ~/.my-git-hooks"
  exit 1
fi

show_help() {
  echo "Usage: my-git-hook <command> [options]"
  echo ""
  echo "Commands:"
  echo "  install    Install hooks into the current git repository"
  echo "             Options:"
  echo "               --path <path>     Specify the repository root (default: current directory)"
  echo "               --force-lefthook  Force Lefthook configuration even if lefthook.yml is missing"
  echo "  help       Show this help message"
  echo ""
}

install_hooks() {
  local target_dir="."
  local force_lefthook=false
  
  # Parse arguments for install command
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --path)
        target_dir="$2"
        shift 2
        ;;
      --force-lefthook)
        force_lefthook=true
        shift
        ;;
      *)
        echo "‚ùå Unknown argument: $1"
        echo "Usage: my-git-hook install [--path <path/to/repo>] [--force-lefthook]"
        exit 1
        ;;
    esac
  done

  # Change to target directory
  if [ ! -d "$target_dir" ]; then
    echo "‚ùå Target directory not found: $target_dir"
    exit 1
  fi
  
  cd "$target_dir" || exit 1
  echo "üìÇ Working in: $(pwd)"

  echo "Using hooks from: $HOOKS_DIR"

  # Ensure we are in a git repository
  if [ ! -d ".git" ]; then
    echo "‚ùå Not a git repository (no .git directory in $(pwd))"
    exit 1
  fi

  # Ensure local hooks are used (overriding any global core.hooksPath)
  git config core.hooksPath .git/hooks
  echo "‚úÖ Configured git to use local hooks (.git/hooks)"

  # Check for lefthook
  if [ -f "lefthook.yml" ] || [ "$force_lefthook" = true ]; then
    if [ "$force_lefthook" = true ]; then
      echo "üëÄ Lefthook forced (--force-lefthook)"
    else
      echo "üëÄ Lefthook detected (lefthook.yml)"
    fi
    
    LEFTHOOK_LOCAL="lefthook-local.yml"
    
    # Create lefthook-local.yml if it doesn't exist
    if [ ! -f "$LEFTHOOK_LOCAL" ]; then
      echo "# lefthook-local.yml generated by my-git-hook" > "$LEFTHOOK_LOCAL"
    fi
    
    # Check if already configured
    if grep -q "gemini-prepare-commit-msg" "$LEFTHOOK_LOCAL"; then
      echo "‚úÖ Hooks already configured in $LEFTHOOK_LOCAL"
    else
      echo "‚ûï Adding hooks to $LEFTHOOK_LOCAL"
      
      cat <<EOF >> "$LEFTHOOK_LOCAL"

prepare-commit-msg:
  commands:
    gemini-prepare-commit-msg:
      run: $HOOKS_DIR/prepare-commit-msg {1} {2} {3}
      interactive: true

commit-msg:
  commands:
    gemini-commit-msg:
      run: $HOOKS_DIR/commit-msg {1}
      interactive: true
EOF
      echo "‚úÖ Added hooks to $LEFTHOOK_LOCAL"
    fi

  else
    echo "üëÄ Lefthook NOT detected. Installing directly to .git/hooks"
    
    mkdir -p .git/hooks
    
    # Symlink prepare-commit-msg
    if [ -f "$HOOKS_DIR/prepare-commit-msg" ]; then
      ln -sf "$HOOKS_DIR/prepare-commit-msg" ".git/hooks/prepare-commit-msg"
      echo "üîó Linked prepare-commit-msg"
    fi
    
    # Symlink commit-msg
    if [ -f "$HOOKS_DIR/commit-msg" ]; then
      ln -sf "$HOOKS_DIR/commit-msg" ".git/hooks/commit-msg"
      echo "üîó Linked commit-msg"
    fi
    
    echo "‚úÖ Hooks installed in .git/hooks"
  fi
}

# Main logic
if [ $# -eq 0 ]; then
  show_help
  exit 1
fi

case "$1" in
  install)
    shift # Remove 'install' from args
    install_hooks "$@"
    ;;
  help)
    show_help
    ;;
  *)
    echo "‚ùå Unknown command: $1"
    show_help
    exit 1
    ;;
esac

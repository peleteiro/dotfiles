#!/bin/bash
# Display PGP or SSH keys from 1Password (public or private)
# Usage: my-key <pgp|ssh> <public|private>

set -e

KEY_TYPE="${1:-}"
KEY_VISIBILITY="${2:-}"

if [ -z "$KEY_TYPE" ] || [ -z "$KEY_VISIBILITY" ]; then
  echo "Usage: my-key <pgp|ssh> <public|private>" >&2
  exit 1
fi

if [ "$KEY_TYPE" != "pgp" ] && [ "$KEY_TYPE" != "ssh" ]; then
  echo "Error: First parameter must be 'pgp' or 'ssh'" >&2
  exit 1
fi

if [ "$KEY_VISIBILITY" != "public" ] && [ "$KEY_VISIBILITY" != "private" ]; then
  echo "Error: Second parameter must be 'public' or 'private'" >&2
  exit 1
fi

# PGP keys
if [ "$KEY_TYPE" = "pgp" ]; then
  OP_PGP_KEY_ID="${OP_PGP_KEY_ID:-b2lpibkkqfqtp5lvvp25ugx3kq}"
  
  if [ "$KEY_VISIBILITY" = "public" ]; then
    # Export from locally imported key (keys are imported during dotfiles setup)
    KEY_ID=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep "^sec" | head -1 | awk '{print $2}' | cut -d'/' -f2)
    if [ -z "$KEY_ID" ]; then
      echo "Error: No PGP keys found locally" >&2
      exit 1
    fi
    gpg --armor --export "$KEY_ID" 2>/dev/null
  else
    # Private key from 1Password
    if ! command -v op > /dev/null 2>&1; then
      echo "Error: 1Password CLI (op) not found" >&2
      exit 1
    fi
    op document get "$OP_PGP_KEY_ID" 2>/dev/null
  fi
fi

# SSH keys
if [ "$KEY_TYPE" = "ssh" ]; then
  OP_SSH_KEY_ID="${OP_SSH_KEY_ID:-}"
  
  if [ -z "$OP_SSH_KEY_ID" ]; then
    echo "Error: OP_SSH_KEY_ID not set" >&2
    exit 1
  fi
  
  if ! command -v op > /dev/null 2>&1; then
    echo "Error: 1Password CLI (op) not found" >&2
    exit 1
  fi
  
  if [ "$KEY_VISIBILITY" = "public" ]; then
    # Try to get public key, or extract from private key
    KEY_CONTENT=$(op item get "$OP_SSH_KEY_ID" --fields "public key" 2>/dev/null || op document get "$OP_SSH_KEY_ID" 2>/dev/null || true)
    if [ -z "$KEY_CONTENT" ] || ! echo "$KEY_CONTENT" | grep -q "ssh-"; then
      # Extract from private key
      PRIVATE_KEY=$(op document get "$OP_SSH_KEY_ID" 2>/dev/null || op item get "$OP_SSH_KEY_ID" --fields "notesPlain" 2>/dev/null || true)
      if [ -n "$PRIVATE_KEY" ] && command -v ssh-keygen > /dev/null 2>&1; then
        TMP_KEY=$(mktemp)
        echo "$PRIVATE_KEY" > "$TMP_KEY"
        chmod 600 "$TMP_KEY"
        ssh-keygen -y -f "$TMP_KEY" 2>/dev/null
        rm -f "$TMP_KEY"
      else
        echo "Error: Could not retrieve SSH public key" >&2
        exit 1
      fi
    else
      echo "$KEY_CONTENT"
    fi
  else
    # Private key from 1Password
    op document get "$OP_SSH_KEY_ID" 2>/dev/null || op item get "$OP_SSH_KEY_ID" --fields "notesPlain" 2>/dev/null
  fi
fi


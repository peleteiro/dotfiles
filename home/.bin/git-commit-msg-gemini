#!/bin/bash
# Git commit message helper using Gemini CLI
# This script generates commit messages using Gemini based on git diff

# Check if gemini CLI is available
if ! command -v gemini > /dev/null 2>&1; then
  # If gemini is not available, exit silently (don't break git commit)
  exit 0
fi

# Get the commit message file path
COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"
SHA1="$3"

# Only generate message for new commits (not merges, amends, etc.)
# COMMIT_SOURCE can be: message, template, merge, squash, commit
# Empty COMMIT_SOURCE means it's a normal commit - generate message
# "message" means user provided -message flag, skip generation
# Other values (merge, squash, etc.) - skip generation
if [ "$COMMIT_SOURCE" = "message" ] || [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
  exit 0
fi

# Get the diff for the staged changes
DIFF=$(git diff --cached)

# If there's no diff, exit
if [ -z "$DIFF" ]; then
  exit 0
fi

# Check if message file already has content (user may have edited it)
if [ -f "$COMMIT_MSG_FILE" ] && [ -s "$COMMIT_MSG_FILE" ]; then
  # Check if it's just the default template or if user has written something
  FIRST_LINE=$(head -n 1 "$COMMIT_MSG_FILE" 2>/dev/null || echo "")
  # If first line is not empty and doesn't look like a template, user has written something
  if [ -n "$FIRST_LINE" ] && [ "$FIRST_LINE" != "#"* ]; then
    exit 0
  fi
fi

# Generate commit message using Gemini
# Create the prompt for Gemini
PROMPT="Based on the following git diff, generate a detailed commit message following conventional commits format (type: description).

Requirements:
- Use conventional commits format (e.g., 'feat:', 'fix:', 'refactor:', 'docs:', etc.)
- Provide a clear and descriptive summary in the first line
- Include a detailed body explaining what was changed and why (if significant)
- Keep all relevant information about the changes
- Do not remove comments or important details from the diff

Git diff:
$DIFF

Generate the complete commit message (subject and body if needed):"

# Call Gemini CLI with the prompt
# Gemini CLI accepts prompts via stdin or as positional arguments
# First try via stdin (better for long prompts with diff)
GEMINI_OUTPUT=$(echo "$PROMPT" | gemini 2>/dev/null)

# Extract the commit message, preserving multiple lines and comments
# Filter out only Gemini CLI metadata, but keep the actual message content
SUGGESTED_MSG=$(echo "$GEMINI_OUTPUT" | \
  grep -v "^Usage:" | \
  grep -v "^Error:" | \
  grep -v "^Warning:" | \
  grep -v "^gemini" | \
  sed '/^$/N;/^\n$/d')  # Remove only excessive blank lines, keep single blank lines

# Trim leading/trailing whitespace but preserve structure
SUGGESTED_MSG=$(echo "$SUGGESTED_MSG" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed ':a;N;$!ba;s/\n\n\n\+/\n\n/g')

# If that didn't work or output is too short, try passing the prompt as a positional argument
if [ -z "$SUGGESTED_MSG" ] || [ ${#SUGGESTED_MSG} -lt 10 ]; then
  # Truncate diff if too long (Gemini CLI may have argument length limits)
  DIFF_PREVIEW=$(echo "$DIFF" | head -n 100)
  SHORT_PROMPT="Based on this git diff, generate a detailed commit message in conventional commits format (type: description). Include a detailed body explaining the changes:

$DIFF_PREVIEW

Generate the complete commit message:"
  
  GEMINI_OUTPUT=$(gemini "$SHORT_PROMPT" 2>/dev/null)
  SUGGESTED_MSG=$(echo "$GEMINI_OUTPUT" | \
    grep -v "^Usage:" | \
    grep -v "^Error:" | \
    grep -v "^Warning:" | \
    grep -v "^gemini" | \
    sed '/^$/N;/^\n$/d')
  SUGGESTED_MSG=$(echo "$SUGGESTED_MSG" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed ':a;N;$!ba;s/\n\n\n\+/\n\n/g')
fi

# If we got a valid suggestion (at least 10 characters), write it to the commit message file
if [ -n "$SUGGESTED_MSG" ] && [ ${#SUGGESTED_MSG} -ge 10 ]; then
  # Write the suggested message to the commit message file
  # Preserve the full message including body and comments
  echo "$SUGGESTED_MSG" > "$COMMIT_MSG_FILE"
fi

exit 0


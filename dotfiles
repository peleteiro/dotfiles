#!/bin/bash
# Main script to manage dotfiles
# Replaces Makefile with subcommands

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
OS=$(uname)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help function
show_help() {
  cat << EOF
Usage: $0 <command> [options]

Available commands:
  check            Verify dotfiles integrity
  apply            Run apply:config, apply:install and apply:files (in order)
  apply:config     Configure operating system (macOS or Linux)
  apply:install    Install packages and applications
  apply:files      Copy dotfiles to home directory
  help             Show this help message

Examples:
  $0 check            # Check if everything is OK
  $0 apply            # Run everything (config + install + files)
  $0 apply:config     # Configure macOS
  $0 apply:install   # Install packages
  $0 apply:files     # Copy only dotfiles

For more information, see README.md
EOF
}

# Function to run commands with feedback
run_command() {
  local cmd="$1"
  local description="$2"
  
  echo -e "${BLUE}â–¶${NC} ${description}..."
  if eval "$cmd"; then
    echo -e "${GREEN}âœ…${NC} ${description} completed"
    echo ""
  else
    echo -e "${RED}âŒ${NC} ${description} failed"
    exit 1
  fi
}

# Command: apply:files
cmd_apply_files() {
  run_command "$DIR/bin/apply-files" "Copying dotfiles"
}

# Command: apply:config
cmd_apply_config() {
  if [[ "$OS" == "Darwin" ]]; then
    run_command "$DIR/bin/apply-config-macos" "Configuring macOS"
  else
    run_command "$DIR/bin/apply-config-linux" "Configuring Linux"
  fi
}

# Command: apply:install
cmd_apply_install() {
  if [[ "$OS" == "Darwin" ]]; then
    run_command "$DIR/bin/apply-install-macos" "Installing packages on macOS"
  else
    run_command "$DIR/bin/apply-install-linux" "Installing packages on Linux"
  fi
}

# Command: check
cmd_check() {
  "$DIR/bin/check"
}

# Command: apply
cmd_apply() {
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BLUE}ğŸš€ Running complete configuration${NC}"
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  
  if [[ "$OS" == "Darwin" ]]; then
    cmd_apply_config
  fi
  
  cmd_apply_install
  cmd_apply_files
  
  echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${GREEN}âœ… Complete configuration finished!${NC}"
  echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "ğŸ’¡ Tip: Run '$0 check' to verify everything is OK"
}

# Process arguments
case "${1:-help}" in
  check)
    cmd_check
    ;;
  apply)
    cmd_apply
    ;;
  apply:config)
    cmd_apply_config
    ;;
  apply:install)
    cmd_apply_install
    ;;
  apply:files)
    cmd_apply_files
    ;;
  help|--help|-h)
    show_help
    ;;
  *)
    echo -e "${RED}âŒ${NC} Unknown command: $1"
    echo ""
    show_help
    exit 1
    ;;
esac

